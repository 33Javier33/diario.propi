<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Recaudación</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --menu-width: 250px;
            --primary-color: #007bff;
            --secondary-color: #28a745;
            
            --bg-main: #f4f4f4;
            --bg-content: #ffffff;
            --text-primary: #333;
            --text-secondary: #555;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --header-bg: #f2f2f2;
            --row-color-even: #ffffff;
            --row-color-odd: #e7f5ff;
            --row-footer-odd: #dbeffc;
            --unread-bg: #fff3cd; /* Amarillo claro para notas no leídas */
        }

        body.dark-mode {
            --bg-main: #121212;
            --bg-content: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --header-bg: #2a2a2a;
            --row-color-even: #1e1e1e;
            --row-color-odd: #2c3e50;
            --row-footer-odd: #34495e;
            --unread-bg: #53450e; /* Amarillo oscuro para notas no leídas en modo oscuro */
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        body.loggedin { display: block; justify-content: initial; align-items: initial; }
        .menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 1002; width: 40px; height: 40px; background-color: var(--primary-color); border: none; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: left 0.3s ease; }
        .menu-toggle span { display: block; width: 22px; height: 2px; background-color: white; margin: 2px 0; transition: all 0.3s ease; }
        .side-menu.open + .main-container .menu-toggle { left: calc(var(--menu-width) + 15px); }
        .menu-toggle.active span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
        .menu-toggle.active span:nth-child(2) { opacity: 0; }
        .menu-toggle.active span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }
        .side-menu { position: fixed; top: 0; left: 0; width: var(--menu-width); height: 100vh; background-color: #2c3e50; z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .side-menu.open { transform: translateX(0); }
        .menu-header { color: white; font-size: 1.4em; font-weight: 700; text-align: center; padding: 20px 10px; border-bottom: 1px solid #4a627a; flex-shrink: 0; }
        .menu-links-container { flex-grow: 1; overflow-y: auto; }
        .side-menu a { color: white; text-decoration: none; padding: 15px 20px; display: block; font-size: 1.0em; transition: background-color 0.2s ease, padding-left 0.2s ease; border-bottom: 1px solid #3e5268; }
        .side-menu a:hover, .side-menu a.active-link { background-color: var(--primary-color); padding-left: 25px; }
        #logoutBtn { background-color: #c82333; border-bottom: none; border-top: 1px solid #4a627a; }
        #logoutBtn:hover { background-color: #a71d2a; }

        .unread-indicator {
            background-color: #dc3545;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        .unread-indicator.show {
            opacity: 1;
        }

        .main-container { transition: margin-left 0.3s ease; width: 100%; }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (min-width: 992px) { body.loggedin { margin-left: var(--menu-width); } .menu-toggle { display: none; } .side-menu { transform: translateX(0); } }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        #loginBox { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); width: 90%; max-width: 350px; text-align: center; }
        #loginBox h2 { margin-bottom: 25px; color: #333; }
        #loginBox label { display: block; margin-bottom: 10px; text-align: left; font-weight: bold; color: #555; }
        #loginBox input[type="text"], #loginBox input[type="password"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        #loginBox button { width: 100%; padding: 12px; background-color: #007bff; border: none; border-radius: 4px; color: white; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px;}
        #loginBox button:hover { background-color: #0056b3; }
        .guest-button { background-color: #6c757d !important; }
        .guest-button:hover { background-color: #5a6268 !important; }
        #loginMessage { color: red; margin-top: 15px; font-weight: bold; }

        .password-wrapper { position: relative; display: flex; align-items: center; }
        .password-wrapper input { width: 100%; padding-right: 40px; }
        .password-wrapper i { position: absolute; right: 10px; cursor: pointer; color: #888; }
        
        #mainContent { display: none; padding: 0 15px; }
        h2, h3 { text-align: center; color: var(--text-primary); }
        h2 { margin-top: 20px; }
        .form-container, .table-container { background-color: var(--bg-content); padding: 20px; margin: 20px auto; border-radius: 8px; box-shadow: 0 0 10px var(--shadow-color); max-width: 800px; }
        
        #ayudaPanel { position: fixed; top: 0; right: 0; width: 380px; max-width: 90%; height: 100%; background-color: var(--bg-content); z-index: 1050; transform: translateX(100%); transition: transform 0.3s ease-in-out; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.2); display: block !important; animation: none; }
        #ayudaPanel.open { transform: translateX(0); }
        #ayudaPanel .form-container { margin-top: 0; padding-top: 50px; box-shadow: none; }
        .close-ayuda { position: absolute; top: 15px; right: 25px; font-size: 30px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        .close-ayuda:hover { color: var(--text-primary); }
        #ayudaPanel h3 { text-align: left; margin-top: 25px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }
        #ayudaPanel p { line-height: 1.6; }
        #ayudaPanel ol, #ayudaPanel ul { padding-left: 25px; }
        #ayudaPanel li { margin-bottom: 10px; }
        #ayudaPanel strong { color: var(--primary-color); }
        #ayudaPanel i { color: var(--secondary-color); margin-right: 5px; }
        #ayudaPanel .note { background-color: var(--bg-main); border-left: 4px solid var(--primary-color); padding: 10px; margin: 15px 0; border-radius: 4px; }
        #ayudaPanel .formula { text-align: center; font-size: 1.1em; margin: 15px 0; padding: 10px; background-color: var(--bg-main); border-radius: 4px; }

        .balance-info-container { position: relative; background-color: var(--bg-main); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color); margin: 0 auto 15px auto; max-width: 400px; }
        .balance-display { display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--text-primary); white-space: nowrap; width: auto; }
        .balance-display .edit-balance-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 14px; margin-left: 8px; padding: 0; transition: color 0.2s ease; }
        .balance-display .edit-balance-btn:hover { color: #0056b3; }
        .balance-display .edit-balance-btn i { pointer-events: none; }
        
        .controls-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px auto; max-width: 900px; padding: 0 20px; }
        .main-buttons-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; width: 100%; margin-bottom: 10px; }
        .control-group, #btnReiniciarFiltros, .data-management-group { display: none; }
        .controls-expanded .control-group, .controls-expanded #btnReiniciarFiltros, .controls-expanded .data-management-group { display: block; }
        .data-management-group { display:flex; flex-wrap:wrap; gap: 8px; justify-content: center; width:100%; margin-top:10px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-secondary); }
        input[type="date"], input[type="tel"], input[type="text"], select, textarea, input[type="file"] { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-content); color: var(--text-primary); }
        button { padding: 8px 12px; background-color: var(--secondary-color); border: none; border-radius: 4px; color: white; font-size: 14px; cursor: pointer; transition: background-color 0.3s ease; white-space: nowrap; }
        button:hover { background-color: #218838; }
        .button-delete { background-color: #dc3545; }
        .button-delete:hover { background-color: #c82333; }
        .button-reset { background-color: #007bff; }
        .button-reset:hover { background-color: #0056b3; }
        .button-copy { background-color: #ffc107; color: #333; }
        .button-copy:hover { background-color: #e0a800; }
        .button-to-data { background-color: #6c757d; color: white; padding: 8px 12px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .button-to-data:hover { background-color: #5a6268; }
        .button-to-data i { font-size: 16px; margin-right: 5px; }
        .button-to-data:not(:has(span)) i { margin-right: 0; }
        .button-danger { background-color: #c82333; }
        .button-danger:hover { background-color: #a71d2a; }
        .button-warning { background-color: #e0a800; color: #333; }
        .button-warning:hover { background-color: #c49200; }
        
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .fab { background-color: #030406c5; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 10px var(--shadow-color); cursor: pointer; transition: all 0.3s ease; }
        .fab:hover { background-color: var(--primary-color); transform: scale(1.05); }
        #scrollToTopBtn { opacity: 0; visibility: hidden; }
        #scrollToTopBtn.show { opacity: 1; visibility: visible; }
        #themeToggle i { transition: transform 0.3s ease; }
        body.dark-mode #themeToggle i { transform: rotate(180deg); }

        #notesFabBtn {
            display: none;
            background-color: #ffc107;
        }
        .pulsing {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
        th { background-color: var(--header-bg); font-weight: bold; }
        tfoot td { font-weight: bold; text-align: left; }
        tfoot tr { background-color: var(--header-bg); }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: var(--bg-content); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 0 10px var(--shadow-color); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: var(--text-primary); text-decoration: none; cursor: pointer; }
        
        .fecha-par tbody tr { background-color: var(--row-color-even); }
        .fecha-impar tbody tr { background-color: var(--row-color-odd); }
        .fecha-impar tfoot tr { background-color: var(--row-footer-odd); }
        .fecha-impar tfoot td, .fecha-par tfoot td { background-color: transparent; }

        #notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .note-card {
            background-color: var(--bg-content);
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px var(--shadow-color);
            position: relative;
            transition: background-color 0.3s;
        }
        .note-unread {
            background-color: var(--unread-bg);
            border-left-color: #ffc107;
        }
        .note-header {
            font-size: 0.8em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        .note-header .author {
            font-weight: bold;
            color: var(--primary-color);
            text-transform: capitalize;
        }
        .note-body {
            font-size: 0.95em;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .note-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        .note-delete-btn:hover {
            color: #dc3545;
        }

        footer { text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.9em; }
        
        @media (max-width: 600px) { 
            .balance-info-container { width: 90%; }
            h2 { margin-top: 20px; } 
            .controls-container { flex-direction: column; align-items: center; } 
            .main-buttons-group { flex-direction: row; justify-content: center; width: 100%; } 
            .main-buttons-group button { flex-grow: 1; min-width: unset; font-size: 13px; padding: 7px 10px; } 
            .main-buttons-group button:nth-child(odd):last-child { width: 100%; } 
            .main-buttons-group button:nth-child(even), .main-buttons-group button:nth-child(odd):not(:last-child) { width: calc(50% - 4px); } 
            .control-group { min-width: unset; width: 100%; } 
            table, thead, tbody, th, td, tr { display: block; } 
            thead tr { position: absolute; top: -9999px; left: -9999px; } 
            tr { border: 1px solid var(--border-color); margin-bottom: 10px; display: flex; flex-wrap: wrap; } 
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; text-align: right; width: 100%; background-color: transparent !important; } 
            td:before { content: attr(data-label); position: absolute; left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; } 
            tfoot tr { display: flex; flex-wrap: wrap; width: 100%; border: 1px solid #ccc; margin-top: 10px; } 
            tfoot td { width: 100%; text-align: right; padding-left: 50%; } 
            tfoot td:first-child { text-align: left; } 
            tfoot td[colspan="2"] { width: calc(100% - 12px); } 
            .fecha-par tr, .fecha-impar tr { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div id="loginBox">
            <h2>Acceso Requerido</h2>
            <form id="loginForm">
                <label for="username">Usuario:</label>
                <input type="text" id="username" required autocomplete="username">
                <label for="password">Contraseña:</label>
                <div class="password-wrapper">
                    <input type="password" id="password" required autocomplete="current-password">
                    <i class="fas fa-eye" id="togglePassword"></i>
                </div>
                <button type="submit">Entrar</button>
                <button type="button" id="guestLoginBtn" class="guest-button">Entrar como Invitado</button>
                <p id="loginMessage" style="display: none;"></p>
            </form>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">
                El usuario y la contraseña deben ser solicitados al administrador.
            </p>
        </div>
    </div>

    <nav id="sideMenu" class="side-menu"></nav>
    <div id="mainContainer" class="main-container">
        <button id="menuToggle" class="menu-toggle" style="display: none;">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <div id="mainContent">
            <section id="historialPanel" class="content-panel">
                <h2>Datos Recaudados</h2>
                <div class="balance-info-container">
                    <div class="balance-display" id="historialBalanceDisplay">
                        Valor del Punto: <span id="displaySaldoGuardadoHistorial"></span> 
                        (<span id="displayFechaSaldoHistorial"></span>)
                        <button class="edit-balance-btn" id="btnEditBalanceHistorial" title="Editar Valor del Punto">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                    <h3>Total Recaudado: <span id="totalRecaudadoHistorial"></span></h3>
                </div>
                <div class="controls-container" id="controlsContainer">
                    <div class="main-buttons-group">
                        <button id="btnMinimizarTabla">Maximizar Tabla</button> 
                        <button id="btnOrdenarFechaAsc" class="button-reset">Fecha (Antiguo)</button>
                        <button id="btnOrdenarFechaDesc" class="button-reset">Fecha (Reciente)</button>
                        <button id="scrollToDataBtn" class="button-to-data" title="Ir a los datos">
                            <i class="fas fa-chart-bar"></i> <span>Ir al Historial</span>
                        </button>
                    </div>
                    <div class="control-group">
                        <label for="filtroFechas">Filtrar por fechas (AAAA-MM-DD, AAAA-MM-DD):</label>
                        <input type="text" id="filtroFechas" placeholder="Ej: 2023-01-01, 2023-01-05">
                    </div>
                    <button id="btnReiniciarFiltros" class="button-reset">Reiniciar Filtros</button>
                    <div class="data-management-group">
                        <button id="btnReiniciarMes" class="button-danger">Reiniciar Mes</button>
                        <button id="btnExportarJson" class="button-reset">Exportar JSON</button>
                        <button id="btnImportarJsonTrigger" class="button-warning">Importar JSON</button>
                        <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                    </div>
                </div>
                <div class="table-container" id="tableContainerScrollTarget">
                    <div id="tablaContainer"></div>
                </div>
            </section>

            <section id="agregarPanel" class="content-panel active">
                <div class="form-container" style="max-width: 400px;">
                    <div class="balance-info-container">
                         <div class="balance-display" id="agregarBalanceDisplay">
                            Valor del Punto: <span id="displaySaldoGuardadoAgregar"></span> 
                            (<span id="displayFechaSaldoAgregar"></span>)
                            <button class="edit-balance-btn" id="btnEditBalanceAgregar" title="Editar Valor del Punto">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <h3>Total Recaudado: <span id="totalRecaudadoAgregar"></span></h3>
                    </div>
                    <hr style="margin-bottom: 25px;">

                    <h2>Agregar Datos</h2>
                    <form id="agregarForm">
                        <label for="tipo">Tipo:</label>
                        <select id="tipo" name="tipo">
                            <option value="Máquinas">Máquinas</option>
                            <option value="Mesas">Mesas</option>
                            <option value="Otras">Otras</option>
                        </select>
                        <label for="fecha">Fecha:</label>
                        <input type="date" id="fecha" name="fecha" required>
                        <label for="monto">Monto Recaudado:</label>
                        <input type="tel" id="monto" name="monto" oninput="formatearMonto(this)" required>
                        <button type="submit">Agregar</button>
                    </form>
                </div>
            </section>

            <section id="importarPanel" class="content-panel">
                 <div class="form-container" style="max-width: 400px;">
                    <h2>Importar Datos desde Texto</h2>
                    <p>Pega aquí el texto de los datos de recaudación (ej. desde WhatsApp):</p>
                    <textarea id="importDataTextarea" rows="10" placeholder="Pega el texto aquí..."></textarea>
                    <button id="btnProcesarImportacion">Procesar Importación</button>
                </div>
            </section>

            <section id="notasPanel" class="content-panel">
                <h2>Bloc de Notas</h2>
                <div class="form-container">
                    <label for="notaMensaje">Escribe una nueva nota:</label>
                    <textarea id="notaMensaje" rows="4" placeholder="Deja un recordatorio o mensaje..."></textarea>
                    <button id="btnAgregarNota">Guardar Nota</button>
                </div>
                <div id="notes-container">
                    <!-- Las notas se cargarán aquí dinámicamente -->
                </div>
            </section>

            <section id="ayudaPanel" class="content-panel">
                <div class="form-container">
                    <span class="close-ayuda">&times;</span>
                    <h2>Guía de Uso</h2>
                    <p style="text-align: center;">Sigue estos pasos para llevar un registro ordenado.</p>
                    <hr style="margin: 20px 0;">
                    <h3><i class="fas fa-plus-circle"></i>Paso 1: Agrega tus Recaudaciones</h3>
                    <p>El primer paso es registrar todo el dinero que entra.</p>
                    <ol>
                        <li>Ve a la pestaña <strong>"Agregar Dato"</strong>.</li>
                        <li>Completa el formulario con el tipo, la fecha y el monto.</li>
                        <li>Haz clic en "Agregar".</li>
                    </ol>
                    <h3><i class="fas fa-history"></i>Paso 2: Revisa y Gestiona tu Historial</h3>
                    <p>En la pestaña <strong>"Historial"</strong> podrás ver y administrar tus registros.</p>
                    <ul>
                        <li><strong>Administrador:</strong> Puede editar y borrar cualquier registro.</li>
                        <li><strong>Invitado:</strong> Solo puede 'Corregir' los datos que él mismo agregó durante la sesión actual. No puede borrar nada.</li>
                    </ul>
                    <h3><i class="fas fa-calculator"></i>Paso 3: El Valor del Punto</h3>
                    <p>El "Valor del Punto" que ves en la parte superior es un dato de referencia que debes calcular e ingresar manualmente. No afecta ningún otro cálculo en la aplicación.</p>
                    <p>Para calcularlo, usa la siguiente fórmula:</p>
                    <div class="formula">
                        <strong>Valor del Punto = Total Recaudado / Cantidad Total de Puntos</strong>
                    </div>
                    <div class="note">
                        <p><strong>Importante:</strong> La división se hace por la cantidad de <strong>puntos</strong>, no por la cantidad de mesas.</p>
                    </div>
                    <p>Una vez que tengas el resultado, haz clic en el ícono del lápiz <i class="fas fa-pencil-alt" style="color: var(--primary-color);"></i> para guardarlo junto con la fecha del cálculo. <strong>Tanto Administradores como Invitados pueden registrar este valor.</strong></p>
                    
                    <h3><i class="fas fa-sticky-note"></i>Paso 4: Bloc de Notas y Notificaciones</h3>
                    <p>La sección de <strong>"Notas"</strong> sirve como un tablero de comunicación entre el Administrador y el Invitado.</p>
                    <ul>
                        <li><strong>Crear una nota:</strong> Simplemente escribe en el cuadro de texto y haz clic en "Guardar Nota".</li>
                        <li><strong>Notificaciones:</strong> Si hay una nota nueva que no has leído (escrita por el otro usuario), verás dos indicadores:
                            <ul>
                                <li>Un <strong>punto rojo</strong> junto a "Notas" en el menú lateral.</li>
                                <li>Un <strong>icono de nota parpadeante</strong> <i class="fas fa-sticky-note" style="color: #ffc107;"></i> en la esquina inferior derecha.</li>
                            </ul>
                        </li>
                        <li><strong>Marcar como Leídas:</strong> Para que las notificaciones desaparezcan, solo tienes que <strong>hacer clic en la pestaña "Notas"</strong>. Las notas no leídas aparecerán resaltadas con un fondo amarillo, y al verlas, volverán a su color normal y los avisos se quitarán.</li>
                        <li><strong>Borrar Notas:</strong> El Administrador puede borrar cualquier nota (incluidas las suyas). El Invitado solo puede borrar las notas que él mismo ha creado.</li>
                    </ul>
                </div>
            </section>
            
            <div class="fab-container">
                <button id="notesFabBtn" class="fab" title="Nuevas Notas">
                    <i class="fas fa-sticky-note"></i>
                </button>
                <button id="ayudaFabBtn" class="fab" title="Ayuda">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button id="themeToggle" class="fab theme-toggle" title="Cambiar Tema">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="scrollToTopBtn" class="fab scroll-to-top" title="Ir al inicio">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
            
            <footer>
                <p>CarlosPN Interactive®</p>
            </footer>
        </div>
    </div> 

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Editar Datos</h2>
            <form id="editarForm">
                <label for="editarTipo">Tipo:</label>
                <select id="editarTipo" name="editarTipo">
                    <option value="Máquinas">Máquinas</option>
                    <option value="Mesas">Mesas</option>
                    <option value="Otras">Otras</option>
                </select>
                <label for="editarFecha">Fecha:</label>
                <input type="date" id="editarFecha" name="editarFecha" required>
                <label for="editarMonto">Monto Recaudado:</label>
                <input type="tel" id="editarMonto" name="editarMonto" oninput="formatearMonto(this)" required>
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>
    <div id="editBalanceModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Editar Valor del Punto</h2>
            <form id="editBalanceForm">
                <div style="margin-bottom: 15px;"> 
                    <label for="editBalanceDate">Fecha del Cálculo:</label>
                    <input type="date" id="editBalanceDate" name="editBalanceDate" required>
                </div>
                <label for="editSaldoActual">Monto del Valor del Punto:</label>
                <input type="tel" id="editSaldoActual" name="editSaldoActual" oninput="formatearMonto(this)" required>
                <button type="submit">Guardar Punto</button>
            </form>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close">×</span>
            <p id="alertMessage" style="text-align: center; margin-top: 20px; font-size: 1.1em;"></p>
            <button id="alertOkBtn" class="button-reset" style="display: block; margin: 20px auto 0 auto; min-width: 100px;">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <p id="confirmMessage" style="text-align: center; margin: 20px 0; font-size: 1.1em; white-space: pre-wrap;"></p>
            <div style="display: flex; justify-content: center; gap: 20px;">
                <button id="confirmOkBtn" style="min-width: 100px;">Confirmar</button>
                <button id="confirmCancelBtn" class="button-delete" style="min-width: 100px;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        const VALID_USERNAME = 'croupier';
        const VALID_PASSWORD = '1234';
        let currentUserRole = null;
        let lastSeenKey = '';
        let notesUpdateInterval = null;
        let dataUpdateInterval = null;


        const loginOverlay = document.getElementById('loginOverlay');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const togglePassword = document.getElementById('togglePassword');
        const guestLoginBtn = document.getElementById('guestLoginBtn');
        const loginMessage = document.getElementById('loginMessage');
        const mainContent = document.getElementById('mainContent');
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhKQTp9kER_H87XLekd3d69u5PK5ZpfpGzKdAtYcfKM0qTUuF5apPvB2UNYSyS2-FR/exec'; 

        const menuToggle = document.getElementById('menuToggle');
        const sideMenu = document.getElementById('sideMenu');

        const setupMenu = () => {
            sideMenu.innerHTML = '<div class="menu-header">Menú</div>'; 
            
            const linksContainer = document.createElement('div');
            linksContainer.className = 'menu-links-container';

            const menuItems = [
                { id: 'agregarPanel', title: 'Agregar Dato', icon: 'fa-plus-circle' },
                { id: 'historialPanel', title: 'Historial', icon: 'fa-history' },
                { id: 'importarPanel', title: 'Importar Texto', icon: 'fa-file-import' },
                { id: 'notasPanel', title: 'Notas', icon: 'fa-sticky-note' }
            ];

            menuItems.forEach(item => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'menu-link';
                link.dataset.target = item.id;
                
                let indicatorHTML = '';
                if (item.id === 'notasPanel') {
                    indicatorHTML = '<span class="unread-indicator" id="notes-indicator"></span>';
                }
                
                link.innerHTML = `<i class="fas ${item.icon}" style="margin-right: 10px;"></i>${item.title} ${indicatorHTML}`;
                linksContainer.appendChild(link);
            });
            
            const logoutLink = document.createElement('a');
            logoutLink.href = '#';
            logoutLink.id = 'logoutBtn';
            logoutLink.innerHTML = `<i class="fas fa-sign-out-alt" style="margin-right: 10px;"></i>Cerrar Sesión`;
            
            logoutLink.addEventListener('click', (event) => {
                event.preventDefault(); 
                logout();
            });

            linksContainer.appendChild(logoutLink);
            sideMenu.appendChild(linksContainer);
        };


        menuToggle.addEventListener('click', () => {
            sideMenu.classList.toggle('open');
            menuToggle.classList.toggle('active');
        });

        function checkLogin() {
            const storedRole = sessionStorage.getItem('userRole');
            if (storedRole === 'admin' || storedRole === 'guest') {
                currentUserRole = storedRole;
                lastSeenKey = `lastSeenNoteTimestamp_${currentUserRole}`; 
                loginOverlay.style.display = 'none';
                mainContent.style.display = 'block';
                menuToggle.style.display = 'flex';
                document.body.classList.add('loggedin');
                initializeApp();
            } else {
                currentUserRole = null;
                loginOverlay.style.display = 'flex';
            }
        }
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                sessionStorage.setItem('userRole', 'admin');
                checkLogin();
            } else {
                loginMessage.textContent = 'Usuario o contraseña incorrectos.';
                loginMessage.style.display = 'block';
            }
        });

        guestLoginBtn.addEventListener('click', () => {
            sessionStorage.setItem('userRole', 'guest');
            sessionStorage.setItem('guestAddedEntries', JSON.stringify([]));
            checkLogin();
        });

        togglePassword.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye-slash');
        });

        function logout() {
            if (notesUpdateInterval) clearInterval(notesUpdateInterval);
            if (dataUpdateInterval) clearInterval(dataUpdateInterval);
            sessionStorage.removeItem('userRole');
            sessionStorage.removeItem('guestAddedEntries');
            location.reload();
        }

        function applyUserPermissions() {
            const isGuest = currentUserRole === 'guest';
            document.getElementById('btnReiniciarMes').style.display = isGuest ? 'none' : '';
            document.getElementById('btnImportarJsonTrigger').style.display = isGuest ? 'none' : '';
        }

        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        themeToggle.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        let datos = [];
        let notes = [];
        let minimizado = true; 
        let editIndex = -1;
        let ordenFecha = 'desc';
        let saldoInicialGuardado = { fecha: null, monto: null };

        async function fetchFromScript(params) {
            const url = new URL(SCRIPT_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data from Apps Script:', error);
                // No show alert for silent updates
                return { status: 'error', message: error.message };
            }
        }

        async function postToScript(params, data) {
            const url = new URL(SCRIPT_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: data ? JSON.stringify(data) : null,
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error posting data to Apps Script:', error);
                showAlert('Error al enviar datos al servidor.');
                return { status: 'error', message: error.message };
            }
        }

        function abrirModal(id) { document.getElementById(id).style.display = 'block'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }
        
        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkBtn = document.getElementById('alertOkBtn');
        function showAlert(message) {
            alertMessage.textContent = message;
            abrirModal('alertModal');
        }
        alertOkBtn.addEventListener('click', () => cerrarModal('alertModal'));

        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        let confirmCallback = null;
        function showConfirm(message, onConfirm) {
            confirmMessage.textContent = message;
            confirmCallback = onConfirm;
            abrirModal('confirmModal');
        }
        confirmOkBtn.addEventListener('click', () => {
            cerrarModal('confirmModal');
            if (confirmCallback) confirmCallback();
        });
        confirmCancelBtn.addEventListener('click', () => cerrarModal('confirmModal'));

        function formatearFecha(fecha, includeTime = false) {
            if (!fecha) return 'N/A';
            const opciones = { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'America/Santiago' };
            if (includeTime) {
                opciones.hour = '2-digit';
                opciones.minute = '2-digit';
            }
            const fechaObj = includeTime ? new Date(fecha) : new Date(fecha + 'T12:00:00');
            return fechaObj.toLocaleString('es-ES', opciones);
        }

        function formatearNumero(numero) {
            if (isNaN(numero) || numero === null) return '$0';
            return `$${Math.ceil(numero).toLocaleString('es-ES').replace(/,/g, '.')}`;
        }
        function formatearMonto(input) {
            let valor = input.value.replace(/\D/g, ''); 
            input.value = valor ? `$${parseFloat(valor).toLocaleString('es-ES')}` : '';
        }

        async function cargarSaldoInicial() {
            const response = await fetchFromScript({ action: 'getSaldo' });
            if(response.status !== 'success') return;
            saldoInicialGuardado = response.data ? 
                { fecha: response.data.fecha || null, monto: response.data.monto || null } : 
                { fecha: null, monto: null };
            actualizarPantalla();
        }

        async function guardarSaldoInicialDesdeModal() {
            const fecha = document.getElementById('editBalanceDate').value;
            let montoInput = document.getElementById('editSaldoActual').value;
            const monto = parseFloat(montoInput.replace(/\./g, '').replace('$', ''));
            if (fecha && !isNaN(monto)) {
                const response = await postToScript({ action: 'updateSaldo' }, { fecha, monto });
                if (response.status === 'success') {
                    showAlert('¡Valor del punto guardado!');
                    cerrarModal('editBalanceModal');
                    await cargarSaldoInicial();
                } else {
                    showAlert('Error al guardar: ' + response.message);
                }
            } else {
                showAlert('Ingresa una fecha y un monto válidos.');
            }
        }

        function actualizarPantalla() {
            const totalRecaudado = datos.reduce((acc, dato) => acc + dato.monto, 0);
            document.getElementById('displaySaldoGuardadoAgregar').textContent = formatearNumero(saldoInicialGuardado.monto);
            document.getElementById('displayFechaSaldoAgregar').textContent = formatearFecha(saldoInicialGuardado.fecha);
            document.getElementById('displaySaldoGuardadoHistorial').textContent = formatearNumero(saldoInicialGuardado.monto);
            document.getElementById('displayFechaSaldoHistorial').textContent = formatearFecha(saldoInicialGuardado.fecha);
            document.getElementById('totalRecaudadoAgregar').textContent = formatearNumero(totalRecaudado);
            document.getElementById('totalRecaudadoHistorial').textContent = formatearNumero(totalRecaudado);
        }

        function abrirModalEditarSaldo() {
            document.getElementById('editBalanceDate').value = saldoInicialGuardado.fecha || '';
            document.getElementById('editSaldoActual').value = saldoInicialGuardado.monto !== null ? String(saldoInicialGuardado.monto) : '';
            formatearMonto(document.getElementById('editSaldoActual'));
            abrirModal('editBalanceModal');
        }

        async function agregarDatos() {
            const performAdd = async () => {
                const maxIndexBeforeAdd = datos.length > 0 ? Math.max(...datos.map(d => d.originalIndex)) : -1;
                const tipo = document.getElementById('tipo').value;
                const fecha = document.getElementById('fecha').value;
                let montoInput = document.getElementById('monto').value;
                const monto = parseFloat(montoInput.replace(/\./g, '').replace('$', ''));

                if (fecha && !isNaN(monto)) {
                    const response = await postToScript({ action: 'add' }, { fecha, tipo, monto });
                    if (response.status === 'success') {
                        document.getElementById('agregarForm').reset();
                        document.getElementById('monto').value = '';
                        await cargarDatosDesdeSheet();

                        if (currentUserRole === 'guest') {
                            const newEntry = datos.find(d => d.originalIndex > maxIndexBeforeAdd);
                            if (newEntry) {
                                const guestEntries = JSON.parse(sessionStorage.getItem('guestAddedEntries') || '[]');
                                guestEntries.push(newEntry.originalIndex);
                                sessionStorage.setItem('guestAddedEntries', JSON.stringify(guestEntries));
                            }
                        }
                        document.querySelector('.menu-link[data-target="historialPanel"]').click();
                    } else {
                        showAlert('Error al agregar: ' + response.message);
                    }
                } else {
                    showAlert('Ingresa fecha y monto válidos.');
                }
            };

            if (currentUserRole === 'guest') {
                showConfirm("Estás agregando un dato como invitado. Podrás corregirlo solo durante esta sesión.\n\n¿Deseas continuar?", performAdd);
            } else {
                await performAdd();
            }
        }

        function abrirModalEditar(index) {
            const dato = datos.find(d => d.originalIndex === index);
            if (!dato) return;
            editIndex = index;
            document.getElementById('editarTipo').value = dato.tipo;
            document.getElementById('editarFecha').value = dato.fecha;
            document.getElementById('editarMonto').value = String(dato.monto); 
            formatearMonto(document.getElementById('editarMonto'));
            abrirModal('editModal');
        }

        async function guardarEdicion() {
            const tipo = document.getElementById('editarTipo').value;
            const fecha = document.getElementById('editarFecha').value;
            let montoInput = document.getElementById('editarMonto').value;
            const monto = parseFloat(montoInput.replace(/\./g, '').replace('$', ''));

            if (fecha && !isNaN(monto)) {
                const response = await postToScript({ action: 'update' }, { sheetIndex: editIndex, fecha, tipo, monto });
                if (response.status === 'success') {
                    cerrarModal('editModal');
                    await cargarDatosDesdeSheet();
                } else {
                    showAlert('Error al actualizar: ' + response.message);
                }
            } else {
                showAlert('Ingresa fecha y monto válidos.');
            }
        }

        async function borrarDato(index) {
            showConfirm('¿Seguro que quieres borrar este dato? Esta acción es permanente.', async () => {
                const response = await postToScript({ action: 'delete' }, { index: index });
                if (response.status === 'success') {
                    await cargarDatosDesdeSheet();
                } else {
                    showAlert('Error al borrar: ' + response.message);
                }
            });
        }
        
        async function reiniciarMes() {
            showConfirm("Esta acción borrará TODOS los datos de forma permanente. ¿Estás seguro?", async () => {
                const response = await postToScript({ action: 'clearAll' });
                if (response.status === 'success') {
                    showAlert("Todos los datos han sido borrados.");
                    datos = [];
                    saldoInicialGuardado = { fecha: null, monto: null };
                    actualizarPantalla();
                    filtrarTabla();
                } else {
                    showAlert('Error al reiniciar: ' + response.message);
                }
            });
        }

        function exportarJson() {
            const dataToExport = { saldoInicialGuardado, datos };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fecha = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `recaudacion_backup_${fecha}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert("Datos exportados correctamente.");
        }

        function importarJson(event) {
            const file = event.target.files[0];
            if (!file) { return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.datos || !importedData.saldoInicialGuardado) throw new Error("Formato de archivo incorrecto.");
                    
                    showConfirm("Esto reemplazará TODOS los datos actuales. ¿Estás seguro de continuar?", async () => {
                        const clearResponse = await postToScript({ action: 'clearAll' });
                        if (clearResponse.status !== 'success') throw new Error('No se pudieron borrar los datos antiguos: ' + clearResponse.message);
                        
                        await postToScript({ action: 'updateSaldo' }, importedData.saldoInicialGuardado);
                        for (const dato of importedData.datos) { await postToScript({ action: 'add' }, dato); }
                        
                        showAlert("¡Importación completada con éxito!");
                        await cargarDatosDesdeSheet();
                        await cargarSaldoInicial();
                    });

                } catch (error) {
                    showAlert("Error al importar el archivo: " + error.message);
                } finally {
                    document.getElementById('jsonFileInput').value = '';
                }
            };
            reader.readAsText(file);
        }

        async function cargarDatosDesdeSheet() {
            const response = await fetchFromScript({ action: 'get' });
            if (response.status === 'success' && response.data) {
                datos = response.data.map((item, index) => ({ ...item, originalIndex: index }));
            } else if (response.status !== 'error') { // Avoid logging network errors as data errors
                console.error('Error al cargar datos:', response.message);
                datos = [];
            }
            filtrarTabla();
            actualizarPantalla();
        }

        function checkUnreadNotes() {
            const lastSeenTimestamp = localStorage.getItem(lastSeenKey) || 0;
            const menuIndicator = document.getElementById('notes-indicator');
            const fabIndicator = document.getElementById('notesFabBtn');
            let hasUnread = false;
            
            const unreadNotes = notes.filter(note => {
                return note.autor !== currentUserRole && new Date(note.fecha).getTime() > lastSeenTimestamp;
            });

            if (unreadNotes.length > 0) {
                hasUnread = true;
            }
            
            menuIndicator.classList.toggle('show', hasUnread);
            fabIndicator.style.display = hasUnread ? 'flex' : 'none';
            fabIndicator.classList.toggle('pulsing', hasUnread);
        }

        function markNotesAsRead() {
            const notesFromOthers = notes.filter(note => note.autor !== currentUserRole);
            if (notesFromOthers.length > 0) {
                const latestNoteTimestamp = new Date(notesFromOthers[0].fecha).getTime();
                localStorage.setItem(lastSeenKey, latestNoteTimestamp);
            } else {
                 localStorage.setItem(lastSeenKey, new Date().getTime());
            }
            checkUnreadNotes();
            renderizarNotas(notes);
        }

        async function cargarNotas() {
            const response = await fetchFromScript({ action: 'getNotes' });
            if (response.status === 'success' && response.data) {
                notes = response.data.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                renderizarNotas(notes);
                checkUnreadNotes();
            } else if (response.status !== 'error') {
                console.error('Error al cargar notas:', response.message);
                document.getElementById('notes-container').innerHTML = '<p>No se pudieron cargar las notas.</p>';
            }
        }
        
        function renderizarNotas(notasToRender) {
            const container = document.getElementById('notes-container');
            const lastSeenTimestamp = localStorage.getItem(lastSeenKey) || 0;
            container.innerHTML = '';
            if (notasToRender.length === 0) {
                container.innerHTML = '<p>Aún no hay notas. ¡Añade la primera!</p>';
                return;
            }

            notasToRender.forEach(nota => {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                
                const noteTimestamp = new Date(nota.fecha).getTime();
                if (nota.autor !== currentUserRole && noteTimestamp > lastSeenTimestamp) {
                    noteCard.classList.add('note-unread');
                }
                
                let deleteButtonHTML = '';
                if (currentUserRole === 'admin' || (currentUserRole === 'guest' && nota.autor === 'guest')) {
                    deleteButtonHTML = `<button class="note-delete-btn" onclick="borrarNota(${nota.originalIndex})" title="Borrar nota"><i class="fas fa-trash-alt"></i></button>`;
                }
                
                noteCard.innerHTML = `
                    ${deleteButtonHTML}
                    <div class="note-header">
                        Por <span class="author">${nota.autor}</span> el ${formatearFecha(nota.fecha, true)}
                    </div>
                    <div class="note-body">${nota.mensaje}</div>
                `;
                container.appendChild(noteCard);
            });
        }

        async function agregarNota() {
            const mensajeInput = document.getElementById('notaMensaje');
            const mensaje = mensajeInput.value.trim();
            if (!mensaje) {
                showAlert('Por favor, escribe un mensaje para la nota.');
                return;
            }
            const autor = currentUserRole;
            const response = await postToScript({ action: 'addNote' }, { autor, mensaje });

            if (response.status === 'success') {
                mensajeInput.value = '';
                await cargarNotas();
            } else {
                showAlert('Error al guardar la nota: ' + response.message);
            }
        }

        async function borrarNota(index) {
            showConfirm('¿Estás seguro de que quieres borrar esta nota permanentemente?', async () => {
                const response = await postToScript({ action: 'deleteNote', index: index });
                if (response.status === 'success') {
                    await cargarNotas();
                } else {
                    showAlert('Error al borrar la nota: ' + response.message);
                }
            });
        }

        function copiarDatosDelDia(fecha) {
            const datosDelDia = datos.filter(dato => dato.fecha === fecha);
            let textoACopiar = `Datos de Recaudación del Día ${formatearFecha(fecha)}:\n`;
            let totalDia = 0;
            const totalesPorTipo = {};
            datosDelDia.forEach(dato => {
                if (!totalesPorTipo[dato.tipo]) totalesPorTipo[dato.tipo] = 0;
                totalesPorTipo[dato.tipo] += dato.monto;
                totalDia += dato.monto;
            });
            for (const tipo in totalesPorTipo) { textoACopiar += `- ${tipo}: ${formatearNumero(totalesPorTipo[tipo])}\n`; }
            textoACopiar += `Total del Día: ${formatearNumero(totalDia)}\n`;
            navigator.clipboard.writeText(textoACopiar).then(() => showAlert('Datos copiados!')).catch(() => showAlert('Error al copiar.'));
        }
        
        async function procesarImportacion() {
            const texto = document.getElementById('importDataTextarea').value;
            if (!texto) { showAlert('Pega el texto de los datos.'); return; }
            const nuevasEntradas = parsearTextoRecaudacion(texto);
            if (nuevasEntradas.length > 0) {
                let importadosConExito = 0;
                for (const entrada of nuevasEntradas) {
                    const response = await postToScript({ action: 'add' }, entrada);
                    if (response.status === 'success') importadosConExito++;
                }
                if (importadosConExito > 0) {
                    showAlert(`Se importaron ${importadosConExito} datos.`);
                    document.getElementById('importDataTextarea').value = '';
                    await cargarDatosDesdeSheet();
                    document.querySelector('.menu-link[data-target="historialPanel"]').click();
                } else {
                    showAlert('No se pudo importar ningún dato.');
                }
            } else {
                showAlert('No se encontraron datos válidos en el texto.');
            }
        }

        function parsearTextoRecaudacion(texto) {
            const lineas = texto.split('\n').map(l => l.trim()).filter(Boolean);
            const entradas = [];
            let fechaActual = null;
            const regexFecha = /Día (\d{2}\/\d{2}\/\d{4})/;
            const regexMonto = /^- (Máquinas|Mesas|Otras|Otros):\s*\$?([\d.,]+)/;
            for (const linea of lineas) {
                const matchFecha = linea.match(regexFecha);
                if (matchFecha) {
                    const [day, month, year] = matchFecha[1].split('/');
                    fechaActual = `${year}-${month}-${day}`;
                    continue;
                }
                const matchMonto = linea.match(regexMonto);
                if (matchMonto && fechaActual) {
                    let tipo = matchMonto[1];
                    if (tipo === 'Otros') tipo = 'Otras'; // Normalizar
                    const monto = parseFloat(matchMonto[2].replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(monto)) entradas.push({ fecha: fechaActual, tipo, monto });
                }
            }
            return entradas;
        }

        function generarTablaHTML(datosParaTabla) {
            const tablaContainer = document.getElementById('tablaContainer');
            tablaContainer.innerHTML = '';
            const datosPorFecha = datosParaTabla.reduce((acc, dato) => {
                (acc[dato.fecha] = acc[dato.fecha] || []).push(dato);
                return acc;
            }, {});
            const fechasOrdenadas = Object.keys(datosPorFecha).sort((a,b) => ordenFecha === 'asc' ? new Date(a) - new Date(b) : new Date(b) - new Date(a));
            
            let colorIndex = 0;
            fechasOrdenadas.forEach(fecha => {
                if (minimizado && fechasOrdenadas.length > 1 && fecha !== (ordenFecha === 'desc' ? fechasOrdenadas[0] : fechasOrdenadas[fechasOrdenadas.length - 1])) {
                   return;
                }
                const colorClass = colorIndex % 2 === 0 ? 'fecha-par' : 'fecha-impar';
                colorIndex++;
                const tabla = document.createElement('table');
                tabla.classList.add(colorClass);
                tabla.innerHTML = `<thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Acciones</th></tr></thead><tbody></tbody><tfoot></tfoot>`;
                const tbody = tabla.querySelector('tbody');
                const tfoot = tabla.querySelector('tfoot');
                let totalDia = 0;
                datosPorFecha[fecha].forEach(dato => {
                    const fila = tbody.insertRow();
                    let accionesHTML = '';
                    const guestEntries = JSON.parse(sessionStorage.getItem('guestAddedEntries') || '[]');
                    const canEdit = (currentUserRole === 'admin') || (currentUserRole === 'guest' && guestEntries.includes(dato.originalIndex));

                    if (canEdit) {
                        const buttonText = currentUserRole === 'guest' ? 'Corregir' : 'Editar';
                        accionesHTML += `<button onclick="abrirModalEditar(${dato.originalIndex})">${buttonText}</button>`;
                    }

                    if (currentUserRole === 'admin') {
                        accionesHTML += `<button class="button-delete" onclick="borrarDato(${dato.originalIndex})">Borrar</button>`;
                    }

                    fila.innerHTML = `<td data-label="Fecha">${formatearFecha(dato.fecha)}</td><td data-label="Tipo">${dato.tipo}</td><td data-label="Monto">${formatearNumero(dato.monto)}</td><td data-label="Acciones">${accionesHTML}</td>`;
                    totalDia += dato.monto;
                });
                tfoot.innerHTML = `<tr><td colspan="2"><strong>Total Día:</strong></td><td>${formatearNumero(totalDia)}</td><td><button class="button-copy" onclick="copiarDatosDelDia('${fecha}')">Copiar</button></td></tr>`;
                tablaContainer.appendChild(tabla);
            });
        }
        
        function minimizarTabla() {
            minimizado = !minimizado;
            document.getElementById('btnMinimizarTabla').textContent = minimizado ? 'Maximizar Tabla' : 'Minimizar Tabla';
            filtrarTabla();
        }

        function filtrarTabla() {
            const filtroFechasInput = document.getElementById('filtroFechas').value.trim();
            let datosFiltrados = [...datos]; 
            if (filtroFechasInput) {
                const fechas = filtroFechasInput.split(',').map(f => f.trim()).filter(Boolean);
                datosFiltrados = datosFiltrados.filter(d => fechas.includes(d.fecha));
            } 
            document.getElementById('controlsContainer').classList.toggle('controls-expanded', !minimizado || !!filtroFechasInput);
            generarTablaHTML(datosFiltrados);
        }
        
        function reiniciarFiltros() {
            document.getElementById('filtroFechas').value = '';
            minimizado = true; 
            document.getElementById('btnMinimizarTabla').textContent = 'Maximizar Tabla'; 
            ordenFecha = 'desc'; 
            filtrarTabla();
        }

        function ordenarPorFecha(orden) {
            ordenFecha = orden;
            filtrarTabla();
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollToData() { document.getElementById('tableContainerScrollTarget').scrollIntoView({ behavior: 'smooth' }); }
        
        window.addEventListener('scroll', () => {
            document.getElementById('scrollToTopBtn').classList.toggle('show', window.scrollY > 200);
        });

        async function initializeApp() {
            setupMenu();
            applyUserPermissions(); 
            applyTheme(localStorage.getItem('theme') || 'light');
            
            // Cargas iniciales
            await cargarDatosDesdeSheet();
            await cargarSaldoInicial();
            await cargarNotas();
            
            minimizado = true; 
            document.getElementById('btnMinimizarTabla').textContent = 'Maximizar Tabla'; 
            ordenarPorFecha('desc');
            
            if (notesUpdateInterval) clearInterval(notesUpdateInterval);
            notesUpdateInterval = setInterval(cargarNotas, 15 * 1000);

            if (dataUpdateInterval) clearInterval(dataUpdateInterval);
            dataUpdateInterval = setInterval(cargarDatosDesdeSheet, 15 * 1000);
            
            document.querySelectorAll('.modal .close').forEach(button => {
                button.onclick = (event) => cerrarModal(event.target.closest('.modal').id);
            });
            window.onclick = (event) => {
                if (event.target.classList.contains('modal')) cerrarModal(event.target.id);
            };

            document.getElementById('agregarForm').onsubmit = (e) => { e.preventDefault(); agregarDatos(); };
            document.getElementById('editarForm').onsubmit = (e) => { e.preventDefault(); guardarEdicion(); };
            document.getElementById('btnProcesarImportacion').onclick = procesarImportacion;
            document.getElementById('btnAgregarNota').onclick = agregarNota;
            
            document.getElementById('btnEditBalanceAgregar').onclick = abrirModalEditarSaldo;
            document.getElementById('btnEditBalanceHistorial').onclick = abrirModalEditarSaldo;
            document.getElementById('editBalanceForm').onsubmit = (e) => { e.preventDefault(); guardarSaldoInicialDesdeModal(); };

            document.getElementById('btnMinimizarTabla').onclick = minimizarTabla;
            document.getElementById('filtroFechas').oninput = filtrarTabla;
            document.getElementById('btnReiniciarFiltros').onclick = reiniciarFiltros;
            document.getElementById('btnOrdenarFechaAsc').onclick = () => ordenarPorFecha('asc');
            document.getElementById('btnOrdenarFechaDesc').onclick = () => ordenarPorFecha('desc');
            document.getElementById('scrollToTopBtn').onclick = scrollToTop;
            document.getElementById('scrollToDataBtn').onclick = scrollToData;
            document.getElementById('notesFabBtn').onclick = () => {
                document.querySelector('.menu-link[data-target="notasPanel"]').click();
            };

            document.getElementById('btnReiniciarMes').onclick = reiniciarMes;
            document.getElementById('btnExportarJson').onclick = exportarJson;
            document.getElementById('btnImportarJsonTrigger').onclick = () => document.getElementById('jsonFileInput').click();
            document.getElementById('jsonFileInput').onchange = importarJson;

            const ayudaPanel = document.getElementById('ayudaPanel');
            const ayudaFabBtn = document.getElementById('ayudaFabBtn');
            const closeAyudaBtn = document.querySelector('.close-ayuda');
            ayudaFabBtn.onclick = () => ayudaPanel.classList.add('open');
            closeAyudaBtn.onclick = () => ayudaPanel.classList.remove('open');
            
            document.querySelectorAll('.menu-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(link.dataset.target).classList.add('active');
                    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active-link'));
                    link.classList.add('active-link');
                    
                    if (link.dataset.target === 'notasPanel') {
                        markNotesAsRead();
                    }

                    if (window.innerWidth < 992) {
                        sideMenu.classList.remove('open');
                        menuToggle.classList.remove('active');
                    }
                };
            });
            document.querySelector('.menu-link[data-target="agregarPanel"]').classList.add('active-link');
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('fecha').value = `${year}-${month}-${day}`; 
        }

        document.addEventListener('DOMContentLoaded', checkLogin);
    </script>
</body>
</html>


