<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Recaudaci√≥n</title>
    <!-- INICIO: Enlaces para PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <!-- FIN: Enlaces para PWA -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --menu-width: 250px;
            --primary-color: #007bff;
            --secondary-color: #28a745;
            
            --bg-main: #f4f4f4;
            --bg-content: #ffffff;
            --text-primary: #333;
            --text-secondary: #555;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --header-bg: #f2f2f2;
            --row-color-even: #ffffff;
            --row-color-odd: #e7f5ff;
            --row-footer-odd: #dbeffc;
        }

        body.dark-mode {
            --bg-main: #121212;
            --bg-content: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --header-bg: #2a2a2a;
            --row-color-even: #1e1e1e;
            --row-color-odd: #2c3e50;
            --row-footer-odd: #34495e;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        body.loggedin { display: block; justify-content: initial; align-items: initial; }
        .menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 1002; width: 40px; height: 40px; background-color: var(--primary-color); border: none; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: left 0.3s ease; }
        .menu-toggle span { display: block; width: 22px; height: 2px; background-color: white; margin: 2px 0; transition: all 0.3s ease; }
        .side-menu.open + .main-container .menu-toggle { left: calc(var(--menu-width) + 15px); }
        .menu-toggle.active span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
        .menu-toggle.active span:nth-child(2) { opacity: 0; }
        .menu-toggle.active span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }
        .side-menu { position: fixed; top: 0; left: 0; width: var(--menu-width); height: 100%; background-color: #2c3e50; z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; padding-top: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .side-menu.open { transform: translateX(0); }
        .side-menu .menu-header { color: white; font-size: 1.4em; font-weight: 700; text-align: center; padding: 20px 10px; border-bottom: 1px solid #4a627a; }
        .side-menu a { color: white; text-decoration: none; padding: 15px 20px; display: block; font-size: 1.0em; transition: background-color 0.2s ease, padding-left 0.2s ease; border-bottom: 1px solid #3e5268; }
        .side-menu a:hover, .side-menu a.active-link { background-color: var(--primary-color); padding-left: 25px; }
        .main-container { transition: margin-left 0.3s ease; width: 100%; }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (min-width: 992px) { body.loggedin { margin-left: var(--menu-width); } .menu-toggle { display: none; } .side-menu { transform: translateX(0); } }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        #loginBox { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); width: 90%; max-width: 350px; text-align: center; }
        #loginBox h2 { margin-bottom: 25px; color: #333; }
        #loginBox label { display: block; margin-bottom: 10px; text-align: left; font-weight: bold; color: #555; }
        #loginBox input[type="text"], #loginBox input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        #loginBox button { width: 100%; padding: 12px; background-color: #007bff; border: none; border-radius: 4px; color: white; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; }
        #loginBox button:hover { background-color: #0056b3; }
        #loginMessage { color: red; margin-top: 15px; font-weight: bold; }
        
        #mainContent { display: none; padding: 0 15px; }
        h2, h3 { text-align: center; color: var(--text-primary); }
        h2 { margin-top: 20px; }
        .form-container, .table-container { background-color: var(--bg-content); padding: 20px; margin: 20px auto; border-radius: 8px; box-shadow: 0 0 10px var(--shadow-color); max-width: 400px; }
        
        .balance-info-container {
            position: relative;
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin: 0 auto 15px auto;
            max-width: 400px;
        }

        .balance-display {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-primary);
            white-space: nowrap;
            width: auto;
        }
        .balance-display .edit-balance-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 14px; margin-left: 8px; padding: 0; transition: color 0.2s ease; }
        .balance-display .edit-balance-btn:hover { color: #0056b3; }
        .balance-display .edit-balance-btn i { pointer-events: none; }
        
        .controls-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px auto; max-width: 900px; padding: 0 20px; }
        .main-buttons-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; width: 100%; margin-bottom: 10px; }
        .control-group, #btnReiniciarFiltros { display: none; }
        .controls-expanded .control-group, .controls-expanded #btnReiniciarFiltros { display: block; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-secondary); }
        input[type="date"], input[type="tel"], input[type="text"], select, .modal-content textarea { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-content); color: var(--text-primary); }
        button { padding: 8px 12px; background-color: var(--secondary-color); border: none; border-radius: 4px; color: white; font-size: 14px; cursor: pointer; transition: background-color 0.3s ease; white-space: nowrap; }
        button:hover { background-color: #218838; }
        .button-delete { background-color: #dc3545; }
        .button-delete:hover { background-color: #c82333; }
        .button-reset { background-color: #007bff; }
        .button-reset:hover { background-color: #0056b3; }
        .button-copy { background-color: #ffc107; color: #333; }
        .button-copy:hover { background-color: #e0a800; }
        .button-to-data { background-color: #6c757d; color: white; padding: 8px 12px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .button-to-data:hover { background-color: #5a6268; }
        .button-to-data i { font-size: 16px; margin-right: 5px; }
        .button-to-data:not(:has(span)) i { margin-right: 0; }
        
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .fab { background-color: #030406c5; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 10px var(--shadow-color); cursor: pointer; transition: all 0.3s ease; }
        .fab:hover { background-color: var(--primary-color); transform: scale(1.05); }
        #scrollToTopBtn { opacity: 0; visibility: hidden; }
        #scrollToTopBtn.show { opacity: 1; visibility: visible; }
        #themeToggle i { transition: transform 0.3s ease; }
        body.dark-mode #themeToggle i { transform: rotate(180deg); }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
        th { background-color: var(--header-bg); font-weight: bold; }
        tfoot td { font-weight: bold; text-align: left; }
        tfoot tr { background-color: var(--header-bg); }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: var(--bg-content); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 0 10px var(--shadow-color); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: var(--text-primary); text-decoration: none; cursor: pointer; }
        
        .fecha-par tbody tr { background-color: var(--row-color-even); }
        .fecha-impar tbody tr { background-color: var(--row-color-odd); }
        .fecha-impar tfoot tr { background-color: var(--row-footer-odd); }
        .fecha-impar tfoot td, .fecha-par tfoot td { background-color: transparent; }

        footer { text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.9em; }
        
        @media (max-width: 600px) { 
            .balance-info-container { width: 90%; }
            h2 { margin-top: 20px; } 
            .controls-container { flex-direction: column; align-items: center; } 
            .main-buttons-group { flex-direction: row; justify-content: center; width: 100%; } 
            .main-buttons-group button { flex-grow: 1; min-width: unset; font-size: 13px; padding: 7px 10px; } 
            .main-buttons-group button:nth-child(odd):last-child { width: 100%; } 
            .main-buttons-group button:nth-child(even), .main-buttons-group button:nth-child(odd):not(:last-child) { width: calc(50% - 4px); } 
            .control-group { min-width: unset; width: 100%; } 
            table, thead, tbody, th, td, tr { display: block; } 
            thead tr { position: absolute; top: -9999px; left: -9999px; } 
            tr { border: 1px solid var(--border-color); margin-bottom: 10px; display: flex; flex-wrap: wrap; } 
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; text-align: right; width: 100%; background-color: transparent !important; } 
            td:before { content: attr(data-label); position: absolute; left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; } 
            tfoot tr { display: flex; flex-wrap: wrap; width: 100%; border: 1px solid #ccc; margin-top: 10px; } 
            tfoot td { width: 100%; text-align: right; padding-left: 50%; } 
            tfoot td:first-child { text-align: left; } 
            tfoot td[colspan="2"] { width: calc(100% - 12px); } 
            .fecha-par tr, .fecha-impar tr { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div id="loginBox">
            <h2>Acceso Requerido</h2>
            <form id="loginForm">
                <label for="username">Usuario:</label>
                <input type="text" id="username" required autocomplete="username">
                <label for="password">Contrase√±a:</label>
                <input type="password" id="password" required autocomplete="current-password">
                <button type="submit">Entrar</button>
                <p id="loginMessage" style="display: none;"></p>
            </form>
        </div>
    </div>

    <nav id="sideMenu" class="side-menu"></nav>
    <div id="mainContainer" class="main-container">
        <button id="menuToggle" class="menu-toggle" style="display: none;">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <div id="mainContent">
            
            <section id="historialPanel" class="content-panel">
                <h2>Datos Recaudados</h2>
                <!-- INICIO: Contenedor de Balance para Historial -->
                <div class="balance-info-container">
                    <div class="balance-display" id="historialBalanceDisplay">
                        Punto Actual: <span id="displaySaldoGuardadoHistorial"></span> 
                        (<span id="displayFechaSaldoHistorial"></span>)
                        <button class="edit-balance-btn" id="btnEditBalanceHistorial" title="Editar Punto Actual">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                    <h3>Total Recaudado: <span id="totalRecaudadoHistorial"></span></h3>
                </div>
                <!-- FIN: Contenedor de Balance para Historial -->
                <div class="controls-container" id="controlsContainer">
                    <div class="main-buttons-group">
                        <button id="btnMinimizarTabla">Maximizar Tabla</button> 
                        <button id="btnOrdenarFechaAsc" class="button-reset">Fecha (Antiguo)</button>
                        <button id="btnOrdenarFechaDesc" class="button-reset">Fecha (Reciente)</button>
                        <button id="scrollToDataBtn" class="button-to-data" title="Ir a los datos">
                            <i class="fas fa-chart-bar"></i> <span>Ir al Historial</span>
                        </button>
                    </div>
                    <div class="control-group">
                        <label for="filtroFechas">Filtrar por fechas (AAAA-MM-DD, AAAA-MM-DD):</label>
                        <input type="text" id="filtroFechas" placeholder="Ej: 2023-01-01, 2023-01-05">
                    </div>
                    <button id="btnReiniciarFiltros" class="button-reset">Reiniciar Filtros</button>
                </div>
                <div class="table-container" id="tableContainerScrollTarget">
                    <div id="tablaContainer"></div>
                </div>
            </section>

            <section id="agregarPanel" class="content-panel active">
                <div class="form-container">
                    <div class="balance-info-container">
                         <div class="balance-display" id="agregarBalanceDisplay">
                            Punto Actual: <span id="displaySaldoGuardadoAgregar"></span> 
                            (<span id="displayFechaSaldoAgregar"></span>)
                            <button class="edit-balance-btn" id="btnEditBalanceAgregar" title="Editar Punto Actual">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <h3>Total Recaudado: <span id="totalRecaudadoAgregar"></span></h3>
                    </div>
                    <hr style="margin-bottom: 25px;">

                    <h2>Agregar Datos</h2>
                    <form id="agregarForm">
                        <label for="tipo">Tipo:</label>
                        <select id="tipo" name="tipo">
                            <option value="M√°quinas">M√°quinas</option>
                            <option value="Mesas">Mesas</option>
                            <option value="Otras">Otras</option>
                        </select>
                        <label for="fecha">Fecha:</label>
                        <input type="date" id="fecha" name="fecha" required>
                        <label for="monto">Monto Recaudado:</label>
                        <input type="tel" id="monto" name="monto" oninput="formatearMonto(this)" required>
                        <button type="submit">Agregar</button>
                    </form>
                </div>
            </section>

            <section id="importarPanel" class="content-panel">
                 <div class="form-container">
                    <h2>Importar Datos desde Texto</h2>
                    <p>Pega aqu√≠ el texto de los datos de recaudaci√≥n (ej. desde WhatsApp):</p>
                    <textarea id="importDataTextarea" rows="10" placeholder="Pega el texto aqu√≠..."></textarea>
                    <button id="btnProcesarImportacion">Procesar Importaci√≥n</button>
                </div>
            </section>

            <div class="fab-container">
                <button id="themeToggle" class="fab theme-toggle" title="Cambiar Tema">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="scrollToTopBtn" class="fab scroll-to-top" title="Ir al inicio">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
            
            <footer>
                <p>CarlosPN Interactive¬Æ</p>
            </footer>

        </div>
    </div> 

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal-id="editModal">√ó</span>
            <h2>Editar Datos</h2>
            <form id="editarForm">
                <label for="editarTipo">Tipo:</label>
                <select id="editarTipo" name="editarTipo">
                    <option value="M√°quinas">M√°quinas</option>
                    <option value="Mesas">Mesas</option>
                    <option value="Otras">Otras</option>
                </select>
                <label for="editarFecha">Fecha:</label>
                <input type="date" id="editarFecha" name="editarFecha" required>
                <label for="editarMonto">Monto Recaudado:</label>
                <input type="tel" id="editarMonto" name="editarMonto" oninput="formatearMonto(this)" required>
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>
    <div id="editBalanceModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal-id="editBalanceModal">√ó</span>
            <h2>Editar Punto Actual</h2>
            <form id="editBalanceForm">
                <div style="margin-bottom: 15px;"> 
                    <label for="editBalanceDate">Fecha del Punto:</label>
                    <input type="date" id="editBalanceDate" name="editBalanceDate" required>
                </div>
                <label for="editSaldoActual">Monto del Punto:</label>
                <input type="tel" id="editSaldoActual" name="editSaldoActual" oninput="formatearMonto(this)" required>
                <button type="submit">Guardar Punto</button>
            </form>
        </div>
    </div>

    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        const VALID_USERNAME = 'croupier';
        const VALID_PASSWORD = '1234';

        const loginOverlay = document.getElementById('loginOverlay');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const mainContent = document.getElementById('mainContent');
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxna9EH5LZPTPCPws58pGro6qCrZ8_zNwvUkUHS28BYfd8CsAcD1MRcqlITbDm4lTk/exec'; 

        const menuToggle = document.getElementById('menuToggle');
        const sideMenu = document.getElementById('sideMenu');

        const setupMenu = () => {
            sideMenu.innerHTML = '<div class="menu-header">Men√∫</div>'; 
            const menuItems = [
                { id: 'agregarPanel', title: 'Agregar Dato', icon: 'fa-plus-circle' },
                { id: 'historialPanel', title: 'Historial', icon: 'fa-history' },
                { id: 'importarPanel', title: 'Importar Datos', icon: 'fa-file-import' }
            ];

            menuItems.forEach(item => {
                const section = document.getElementById(item.id);
                if (section) {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.innerHTML = `<i class="fas ${item.icon}" style="margin-right: 10px;"></i>${item.title}`;
                    link.className = 'menu-link';
                    link.dataset.target = item.id;
                    if (section.classList.contains('active')) { link.classList.add('active-link'); }
                    sideMenu.appendChild(link);
                }
            });

            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    document.querySelectorAll('.content-panel').forEach(panel => panel.classList.remove('active'));
                    document.getElementById(targetId).classList.add('active');
                    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active-link'));
                    link.classList.add('active-link');
                    if (window.innerWidth < 992) {
                        sideMenu.classList.remove('open');
                        menuToggle.classList.remove('active');
                    }
                });
            });
        };

        menuToggle.addEventListener('click', () => {
            sideMenu.classList.toggle('open');
            menuToggle.classList.toggle('active');
        });

        function checkLogin() {
            const storedLogin = sessionStorage.getItem('isLoggedIn');
            if (storedLogin === 'true') {
                loginOverlay.style.display = 'none';
                mainContent.style.display = 'block';
                menuToggle.style.display = 'flex';
                document.body.classList.add('loggedin');
                initializeApp();
            } else {
                loginOverlay.style.display = 'flex';
                mainContent.style.display = 'none';
                menuToggle.style.display = 'none';
                document.body.classList.remove('loggedin');
            }
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;
            if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                checkLogin();
            } else {
                loginMessage.textContent = 'Usuario o contrase√±a incorrectos.';
                loginMessage.style.display = 'block';
            }
        });

        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        let datos = [];
        let minimizado = true; 
        let editIndex = -1;
        let ordenFecha = 'desc';
        let saldoInicialGuardado = { fecha: null, monto: null };

        async function fetchFromScript(params) {
            const url = new URL(SCRIPT_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data from Apps Script:', error);
                alert('Error al conectar con el servidor de datos.');
                return { status: 'error', message: error.message };
            }
        }

        async function postToScript(params, data) {
            const url = new URL(SCRIPT_URL);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error posting data to Apps Script:', error);
                alert('Error al enviar datos al servidor.');
                return { status: 'error', message: error.message };
            }
        }

        function abrirModal(id) { document.getElementById(id).style.display = 'block'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }
        function formatearFecha(fecha) {
            if (!fecha) return 'N/A';
            const opciones = { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'America/Santiago' };
            const fechaObj = new Date(fecha + 'T12:00:00');
            return fechaObj.toLocaleDateString('es-ES', opciones);
        }
        function formatearNumero(numero) {
            if (isNaN(numero) || numero === null) return '$0';
            return `$${Math.ceil(numero).toLocaleString('es-ES').replace(/,/g, '.')}`;
        }
        function formatearMonto(input) {
            let valor = input.value.replace(/\D/g, ''); 
            input.value = valor ? `$${parseFloat(valor).toLocaleString('es-ES')}` : '';
        }

        async function cargarSaldoInicial() {
            const response = await fetchFromScript({ action: 'getSaldo' });
            saldoInicialGuardado = (response.status === 'success' && response.data) ? 
                { fecha: response.data.fecha || null, monto: response.data.monto || null } : 
                { fecha: null, monto: null };
            mostrarSaldoInicial();
        }

        async function guardarSaldoInicialDesdeModal() {
            const fecha = document.getElementById('editBalanceDate').value;
            let montoInput = document.getElementById('editSaldoActual').value;
            const monto = parseFloat(montoInput.replace(/\./g, '').replace('$', ''));
            if (fecha && !isNaN(monto)) {
                const response = await postToScript({ action: 'updateSaldo' }, { fecha, monto });
                if (response.status === 'success') {
                    alert('¬°Punto actual guardado!');
                    cerrarModal('editBalanceModal');
                    await cargarSaldoInicial();
                } else {
                    alert('Error al guardar: ' + response.message);
                }
            } else {
                alert('Ingresa una fecha y un monto v√°lidos.');
            }
        }

        function mostrarSaldoInicial() {
            // Actualizar en ambas secciones
            document.getElementById('displaySaldoGuardadoAgregar').textContent = formatearNumero(saldoInicialGuardado.monto);
            document.getElementById('displayFechaSaldoAgregar').textContent = formatearFecha(saldoInicialGuardado.fecha);
            document.getElementById('displaySaldoGuardadoHistorial').textContent = formatearNumero(saldoInicialGuardado.monto);
            document.getElementById('displayFechaSaldoHistorial').textContent = formatearFecha(saldoInicialGuardado.fecha);
        }

        function abrirModalEditarSaldo() {
            document.getElementById('editBalanceDate').value = saldoInicialGuardado.fecha || '';
            document.getElementById('editSaldoActual').value = saldoInicialGuardado.monto !== null ? String(saldoInicialGuardado.monto) : '';
            formatearMonto(document.getElementById('editSaldoActual'));
            abrirModal('editBalanceModal');
        }

        async function agregarDatos() {
            const tipo = document.getElementById('tipo').value;
            const fecha = document.getElementById('fecha').value;
            let montoInput = document.getElementById('monto').value;
            const monto = parseFloat(montoInput.replace(/\./g, '').replace('$', ''));

            if (fecha && !isNaN(monto)) {
                const response = await postToScript({ action: 'add' }, { fecha, tipo, monto });
                if (response.status === 'success') {
                    document.getElementById('agregarForm').reset();
                    document.getElementById('monto').value = '';
                    await cargarDatosDesdeSheet();
                    document.querySelector('.menu-link[data-target="historialPanel"]').click();
                } else {
                    alert('Error al agregar: ' + response.message);
                }
            } else {
                alert('Ingresa fecha y monto v√°lidos.');
            }
        }

        function abrirModalEditar(index) {
            const dato = datos.find(d => d.originalIndex === index);
            if (!dato) return;
            editIndex = index;
            document.getElementById('editarTipo').value = dato.tipo;
            document.getElementById('editarFecha').value = dato.fecha;
            document.getElementById('editarMonto').value = String(dato.monto); 
            formatearMonto(document.getElementById('editarMonto'));
            abrirModal('editModal');
        }

        async function guardarEdicion() {
            const tipo = document.getElementById('editarTipo').value;
            const fecha = document.getElementById('editarFecha').value;
            let montoInput = document.getElementById('editarMonto').value;
            const monto = parseFloat(montoInput.replace(/\./g, '').replace('$', ''));

            if (fecha && !isNaN(monto)) {
                const response = await postToScript({ action: 'update' }, { sheetIndex: editIndex, fecha, tipo, monto });
                if (response.status === 'success') {
                    cerrarModal('editModal');
                    await cargarDatosDesdeSheet();
                } else {
                    alert('Error al actualizar: ' + response.message);
                }
            } else {
                alert('Ingresa fecha y monto v√°lidos.');
            }
        }

        async function borrarDato(index) {
            if (confirm('¬øSeguro que quieres borrar este dato?')) {
                const response = await postToScript({ action: 'delete' }, { index: index });
                if (response.status === 'success') {
                    await cargarDatosDesdeSheet();
                } else {
                    alert('Error al borrar: ' + response.message);
                }
            }
        }

        async function cargarDatosDesdeSheet() {
            const response = await fetchFromScript({ action: 'get' });
            if (response.status === 'success' && response.data) {
                datos = response.data.map((item, index) => ({ ...item, originalIndex: index }));
            } else {
                console.error('Error al cargar datos:', response.message);
                datos = [];
            }
            filtrarTabla();
        }

        function copiarDatosDelDia(fecha) {
            const datosDelDia = datos.filter(dato => dato.fecha === fecha);
            let textoACopiar = `Datos de Recaudaci√≥n del D√≠a ${formatearFecha(fecha)}:\n`;
            let totalDia = 0;
            const totalesPorTipo = {};
            datosDelDia.forEach(dato => {
                if (!totalesPorTipo[dato.tipo]) totalesPorTipo[dato.tipo] = 0;
                totalesPorTipo[dato.tipo] += dato.monto;
                totalDia += dato.monto;
            });
            for (const tipo in totalesPorTipo) {
                textoACopiar += `- ${tipo}: ${formatearNumero(totalesPorTipo[tipo])}\n`;
            }
            textoACopiar += `Total del D√≠a: ${formatearNumero(totalDia)}\n`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textoACopiar).then(() => alert('Datos copiados!')).catch(() => alert('Error al copiar.'));
            } else {
                const temp = document.createElement('textarea');
                temp.value = textoACopiar;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                alert('Datos copiados!');
            }
        }
        
        async function procesarImportacion() {
            const texto = document.getElementById('importDataTextarea').value;
            if (!texto) { alert('Pega el texto de los datos.'); return; }
            const nuevasEntradas = parsearTextoRecaudacion(texto);
            if (nuevasEntradas.length > 0) {
                let importadosConExito = 0;
                for (const entrada of nuevasEntradas) {
                    const response = await postToScript({ action: 'add' }, entrada);
                    if (response.status === 'success') importadosConExito++;
                }
                if (importadosConExito > 0) {
                    alert(`Se importaron ${importadosConExito} datos.`);
                    await cargarDatosDesdeSheet();
                    document.querySelector('.menu-link[data-target="historialPanel"]').click();
                } else {
                    alert('No se pudo importar ning√∫n dato.');
                }
            } else {
                alert('No se encontraron datos v√°lidos en el texto.');
            }
        }

        function parsearTextoRecaudacion(texto) {
            const lineas = texto.split('\n').map(l => l.trim()).filter(Boolean);
            const entradas = [];
            let fechaActual = null;
            const regexFecha = /D√≠a (\d{2}\/\d{2}\/\d{4})/;
            const regexMonto = /^- (M√°quinas|Mesas|Otras|Otros):\s*\$?([\d.,]+)/;
            for (const linea of lineas) {
                const matchFecha = linea.match(regexFecha);
                if (matchFecha) {
                    const [day, month, year] = matchFecha[1].split('/');
                    fechaActual = `${year}-${month}-${day}`;
                    continue;
                }
                const matchMonto = linea.match(regexMonto);
                if (matchMonto && fechaActual) {
                    const tipo = matchMonto[1];
                    const monto = parseFloat(matchMonto[2].replace(/\./g, '').replace(',', '.'));
                    if (!isNaN(monto)) entradas.push({ fecha: fechaActual, tipo, monto });
                }
            }
            return entradas;
        }

        function generarTablaHTML(datosParaTabla, totalGlobal) {
            const tablaContainer = document.getElementById('tablaContainer');
            tablaContainer.innerHTML = '';
            const datosPorFecha = datosParaTabla.reduce((acc, dato) => {
                (acc[dato.fecha] = acc[dato.fecha] || []).push(dato);
                return acc;
            }, {});
            
            const fechasOrdenadas = Object.keys(datosPorFecha);
            fechasOrdenadas.sort((a,b) => ordenFecha === 'asc' ? new Date(a) - new Date(b) : new Date(b) - new Date(a));
            
            let colorIndex = 0;
            
            fechasOrdenadas.forEach(fecha => {
                if (minimizado && fechasOrdenadas.length > 1) {
                   const fechaVisible = ordenFecha === 'desc' ? fechasOrdenadas[0] : fechasOrdenadas[fechasOrdenadas.length - 1];
                   if(fecha !== fechaVisible) return;
                }

                const colorClass = colorIndex % 2 === 0 ? 'fecha-par' : 'fecha-impar';
                colorIndex++;

                const tabla = document.createElement('table');
                tabla.classList.add(colorClass);
                
                tabla.innerHTML = `<thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Acciones</th></tr></thead><tbody></tbody><tfoot></tfoot>`;
                const tbody = tabla.querySelector('tbody');
                const tfoot = tabla.querySelector('tfoot');
                let totalDia = 0;
                datosPorFecha[fecha].forEach(dato => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td data-label="Fecha">${formatearFecha(dato.fecha)}</td>
                        <td data-label="Tipo">${dato.tipo}</td>
                        <td data-label="Monto">${formatearNumero(dato.monto)}</td>
                        <td data-label="Acciones">
                            <button onclick="abrirModalEditar(${dato.originalIndex})">Editar</button>
                            <button class="button-delete" onclick="borrarDato(${dato.originalIndex})">Borrar</button>
                        </td>`;
                    totalDia += dato.monto;
                });
                tfoot.innerHTML = `<tr><td colspan="2"><strong>Total D√≠a:</strong></td><td>${formatearNumero(totalDia)}</td><td><button class="button-copy" onclick="copiarDatosDelDia('${fecha}')">Copiar</button></td></tr>`;
                tablaContainer.appendChild(tabla);
            });
            // Actualizar en ambas secciones
            document.getElementById('totalRecaudadoAgregar').textContent = formatearNumero(totalGlobal);
            document.getElementById('totalRecaudadoHistorial').textContent = formatearNumero(totalGlobal);
        }
        
        function minimizarTabla() {
            minimizado = !minimizado;
            document.getElementById('btnMinimizarTabla').textContent = minimizado ? 'Maximizar Tabla' : 'Minimizar Tabla';
            filtrarTabla();
        }

        function filtrarTabla() {
            const filtroFechasInput = document.getElementById('filtroFechas').value.trim();
            let datosFiltrados = [...datos]; 

            if (filtroFechasInput) {
                const fechas = filtroFechasInput.split(',').map(f => f.trim()).filter(Boolean);
                datosFiltrados = datosFiltrados.filter(d => fechas.includes(d.fecha));
            } 
            
            datosFiltrados.sort((a, b) => {
                const dateA = new Date(a.fecha);
                const dateB = new Date(b.fecha);
                return ordenFecha === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            const totalParcial = datosFiltrados.reduce((acc, dato) => acc + dato.monto, 0);
            generarTablaHTML(datosFiltrados, totalParcial);
            document.getElementById('controlsContainer').classList.toggle('controls-expanded', !minimizado || !!filtroFechasInput);
        }
        
        function reiniciarFiltros() {
            document.getElementById('filtroFechas').value = '';
            minimizado = true; 
            document.getElementById('btnMinimizarTabla').textContent = 'Maximizar Tabla'; 
            ordenFecha = 'desc'; 
            filtrarTabla();
        }

        function ordenarPorFecha(orden) {
            ordenFecha = orden;
            filtrarTabla();
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollToData() { document.getElementById('tableContainerScrollTarget').scrollIntoView({ behavior: 'smooth' }); }
        
        window.addEventListener('scroll', () => {
            document.getElementById('scrollToTopBtn').classList.toggle('show', window.scrollY > 200);
        });

        async function initializeApp() {
            setupMenu();
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            await cargarDatosDesdeSheet();
            await cargarSaldoInicial();
            minimizado = true; 
            document.getElementById('btnMinimizarTabla').textContent = 'Maximizar Tabla'; 
            ordenarPorFecha('desc');
            
            document.querySelectorAll('.modal .close').forEach(button => {
                button.addEventListener('click', (event) => {
                    cerrarModal(event.target.dataset.modalId);
                });
            });
            document.getElementById('agregarForm').addEventListener('submit', async (e) => {
                e.preventDefault(); 
                await agregarDatos();
            });
            document.getElementById('editarForm').addEventListener('submit', async (e) => {
                e.preventDefault(); 
                await guardarEdicion();
            });
            document.getElementById('btnProcesarImportacion').addEventListener('click', procesarImportacion);
            
            // Asignar evento a ambos botones de editar balance
            document.getElementById('btnEditBalanceAgregar').addEventListener('click', abrirModalEditarSaldo);
            document.getElementById('btnEditBalanceHistorial').addEventListener('click', abrirModalEditarSaldo);

            document.getElementById('editBalanceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await guardarSaldoInicialDesdeModal();
            });
            document.getElementById('btnMinimizarTabla').addEventListener('click', minimizarTabla);
            document.getElementById('filtroFechas').addEventListener('input', filtrarTabla);
            document.getElementById('btnReiniciarFiltros').addEventListener('click', reiniciarFiltros);
            document.getElementById('btnOrdenarFechaAsc').addEventListener('click', () => ordenarPorFecha('asc'));
            document.getElementById('btnOrdenarFechaDesc').addEventListener('click', () => ordenarPorFecha('desc'));
            document.getElementById('scrollToTopBtn').addEventListener('click', scrollToTop);
            document.getElementById('scrollToDataBtn').addEventListener('click', scrollToData);
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('fecha').value = `${year}-${month}-${day}`; 
        }

        document.addEventListener('DOMContentLoaded', checkLogin);
    </script>
</body>
</html>


